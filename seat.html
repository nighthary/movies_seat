<!DOCTYPE html>
<html>
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta name="viewport" id="viewport_map"
          content="user-scalable=no, initial-scale=1, width=device-width, height=device-height" />
    <script src="scripts/seat.js"></script>
</head>
<style type="text/css">
    *{
        margin: 0;
        padding: 0;
        user-select: none;
    }

    *, :after, :before {
        -webkit-tap-highlight-color: rgba(0,0,0,0);
    }
    html, body{
        width: 100%;
        height: 100%;
    }
    .demo{
        touch-action: auto;
        width: 100%;
        height: auto;
        float: left;
        overflow: hidden;
    }
    #seats{
        position: absolute;
    }
</style>
<body>
    <div class="demo">
        <div class="container">
            <canvas id="seats">[Your browser is too old!]</canvas>
        </div>
    </div>
    <script type="text/javascript" src="https://cdn.staticfile.org/touchjs/0.2.14/touch.min.js
"></script>
    <script type="text/javascript">
        document.addEventListener('touchmove', function(e){
            e.preventDefault()
        })
    var nowScale = 1;
    var initScale = 0, maxScale = 1;
    var seatList = [];
    var normalX = 40, isScale = false, normalY = 100;
    var isPinching = false
    var canvas = document.getElementById('seats')
    var cxt = canvas.getContext('2d')
    var container = document.querySelector('.container')
    var windowWidth = window.screen.width,
        windowHeight = window.screen.height;

    var width = max_column * 40 + 50
    var height = max_row * 40 + 20

    canvas.setAttribute('width', width)
    canvas.setAttribute('height', height)

    container.style.width = width + 'px'
    container.style.height = height + 'px'

    var scale = windowWidth/ width;
    initScale = scale;
    nowScale = scale
    // transformContainer({
    //     scale: initScale
    // })

    // flag 标示 0：普通座位，1：情侣左座，2：情侣右座
    // status 0-已售 1-正常 2-已选择
    var _seats = JSON.parse(JSON.stringify(seats))
    function initCanvas(x, y){
        _seats.forEach((elem) => {
            let {left_px, top_px, column, row, flag, status} = elem

            if(column === 1){// 第一列
                left_px = left_px
            } else if(column !== 1 && flag != 2){ // 非第一列且非情侣右座
                left_px += (column - 1) * 10
            } else if(column !== 1 && flag === 2){ // 非第一列且情侣右座
                left_px += (column - 2) * 10
            }

            if(row !== 1){
                top_px += (row - 1) * 10
            }
            var img = null;
            if(status === 1){
                img = new Image();
                img.src = 'images/seat@3x.png';
            } else if(status === 2){
                img = new Image();
                img.src = 'images/seat-selected@3x.png';
            } else if(status === 0){ // 已售
                img = new Image();
                img.src = 'images/seat-buyed@3x.png';
            }
            seatList.push({
                x: left_px,
                y: top_px
            })
            img.onload = function(){
                drawCanvas(canvas, left_px, top_px, 30 , 30, img)
            }
        })
    }

    function drawCanvas(canvas, x, y, width, height, img){
        cxt.drawImage(img, x, y, width, height)
    }

    function transformContainer(transform){
        var str = []
        if(transform.scale){
            str.push(`scale(${transform.scale}, ${transform.scale})`)
        } else {
            str.push(`scale(${nowScale}, ${nowScale})`)
        }

        if(transform.x){
            str.push(`translateX(${transform.x}px)`)
        } else {
            str.push(`translateX(0px)`)
        }

        if(transform.y){
            str.push(`translateY(${transform.y}px)`)
        } else {
            str.push(`translateY(0px)`)
        }

        if(transform.z){
            str.push(`translateZ(${transform.z}px)`)
        } else {
            str.push(`translateZ(0px)`)
        }

        container.style.transform = str.join(' ')
        container.style.transformOrigin = `${normalX}px ${normalY}px 0px`
        container.style.transition = 'transform .3s ease'
        container.style.width = width + 'px'
    }

    function addEventListener(target){
        var _container = document.querySelector('.container')

        touch.on(target, 'doubletap', function(ev){
            if(nowScale > initScale){
                nowScale = initScale
                isScale = false
            } else {
                isScale = true
                nowScale = maxScale
            }
            transformContainer({
                scale: nowScale
            })
        })

        touch.on(target, 'dragstart', function(ev){
            var disX = ev.distanceX, disY = ev.distanceY;
            var transformStr = _container.style.transform;

            var transXRegex = /\.*translateX\(([0-9]*|\-[0-9]*)px\)/i;
            transXRegex.test(transformStr)
            var translateX = RegExp.$1

            var transYRegex = /\.*translateY\(([0-9]*|\-[0-9]*)px\)/i;
            transYRegex.test(transformStr)
            var translateY = RegExp.$1
            if(!isScale){
                transformContainer({
                    x: Number(translateX) + parseInt(disX) * 15,
                    y: translateY,
                    scale: nowScale
                })
            } else {
                transformContainer({
                    x: Number(translateX) + parseInt(disX) * 10,
                    y: Number(translateY) + parseInt(disY) * 10,
                    scale: nowScale
                })
            }
        })

        //拖拽结束判断边界进行回弹
        touch.on(target, 'dragend', function(ev){

            var transformStr = _container.style.transform;

            var transZRegex = /\.*translateX\(([0-9]*|\-[0-9]*)px\)/i;
            transZRegex.test(transformStr)
            var translateX = RegExp.$1

            var transYRegex = /\.*translateY\(([0-9]*|\-[0-9]*)px\)/i;
            transYRegex.test(transformStr)
            var translateY = RegExp.$1

            var taransform = {}
            if(!isScale){
                taransform = {
                    x: translateX,
                    y: translateY,
                    scale: nowScale
                }

                if(Number(translateX) > 100){
                    taransform.x = 0
                } else if(Number(translateX) < -normalX){
                    taransform.x = -normalX
                }
            } else {
                taransform = {
                    x: translateX,
                    y: translateY,
                    scale: nowScale
                }

                // x： 左边界  Number(translateX) > nowScale * normalX 临界点 transformX = 0
                //    右边界   Number(translateX) < width * nowScale / 2 临界点 transformX =  -width * nowScale / 2 - normalX * nowScale

                if(Number(translateX) > nowScale * normalX){
                    taransform.x = 0
                } else if(Number(translateX) < -width * nowScale / 2){
                    taransform.x = -width * nowScale / 2 - normalX * nowScale
                }

                // y 上边界 Number(translateY) > initScale * normalY 临界点 transformY = 0
                //   下边界 Number(translateY) < -height * nowScale / 3 临界点 0

                if(Number(translateY) > initScale * normalY || Number(translateY) < -initScale * normalY ){
                    taransform.y = 0
                }
            }

            transformContainer(taransform)

        })

        touch.on(target, 'pinchend', function(ev){

            var transform = {
                x: 0,
                y: 0,
                scale: nowScale
            }
            isPinching = false
            transformContainer(transform)  
        }) 

        touch.on(target, 'pinchin', function(ev){
            // if(!isPinching){
            //     nowScale = initScale
            //     isPinching = true
            //     isScale = true
            // }

            var scale = ev.scale

            // nowScale = scale < initScale ? initScale : scale
            // nowScale = scale
            nowScale = initScale
            var transform = {
                x: 0,
                y: 0,
                scale: nowScale
            }
            isScale = true
            transformContainer(transform)
        })

        touch.on(target, 'pinchout', function(ev){
            // if(!isPinching){
            //     nowScale = maxScale
            //     isPinching = true
            //     isScale = true
            // }

            var scale = ev.scale

            // nowScale = scale > maxScale ? maxScale : scale

            nowScale = maxScale
            var transform = {
                x: 0,
                y: 0,
                scale: nowScale
            }
            isScale = true
            transformContainer(transform)
        })

        touch.on(canvas, 'tap', function(ev){
            var touches = ev.originEvent.changedTouches;

            var pageX = touches[0].pageX;
            var pageY = touches[0].pageY;

            var img = new Image();
            img.src = 'images/seat-selected@3x.png';
            var cc = canvas.getBoundingClientRect();
            var cX = cc.x, cY = cc.y;
            console.log(`${cc.x}===${cc.y}` + '====' + pageX + '====' + pageY)
            cxt.drawImage(img, (pageX - cX) / nowScale , (pageY - cY) / nowScale, 30, 30)
            // var aa = cxt.isPointInPath((pageX - cX) / nowScale , (pageY - cY) / nowScale)
            var aa = cxt.isPointInPath(pageX , pageY )
            console.log(aa)
            // cxt.drawImage(img, (pageX + cX) / nowScale, (pageY + cY) / nowScale, 30, 30)
            // cxt.drawImage(img, pageX , pageY , 30, 30)

        })
    }

    // canvas.addEventListener('click', function(event){
    //     var x = canvas.getBoundingClientRect()   .left;
    //     var y = canvas.getBoundingClientRect().top;

    //     img = new Image();
    //     img.src = 'images/seat-buyed@3x.png';
    //     cxt.drawImage(img, x, y, 30, 30)
    // })
    addEventListener('.demo')
    initCanvas()
    </script>
</body>
</html>
